/*! project3 2017-05-03 */

function Steampunked(a){var b=this;this.sel=$(a),this.grid,this.init=function(){this.sel.html('<div class="title"><h1>STEAMPUNKED</h1><p><label for="name1">Player one:  </label><input type="text" name="name1" id="name1"></p><p><label for="name2">Player two:  </label><input type="text" name="name2" id="name2"></p> <p><input type="submit"name="start_game" value="Start Game"></p> <div><p>6x6<input type="radio" value="6" name="size">10x10<input type="radio" value="10" name="size">20x20<input type="radio" value="20" name="size"> </p></div>'),$(this.sel.find("input[type='submit']")).click(function(a){a.preventDefault();var c=$($(b.sel.find("input[type='text']"))[0]).val(),d=$($(b.sel.find("input[type='text']"))[1]).val(),e=$($(b.sel.find("input[name='size']:checked"))).val();c||(c="player1"),d||(d="player2"),e=e?parseInt(e):6,b.sel.html('<div class="game"></div><div class="message"></div><div class="bottom"></div>'),b.startGame(c,d,e)})},this.startGame=function(a,b,c){this.grid=new Grid(c,".game",a,b,this.sel),this.grid.init()},this.init()}function StartingLayout(a){this.sel=$(a),this.init=function(){this.sel.html('<p><label for="name1">Player one:  </label><input type="text" name="name1" id="name1"></p><p><label for="name2">Player two:  </label><input type="text" name="name2" id="name2"></p> <p><input type="submit"name="start_game" value="Start Game"></p> <div><p>6x6<input type="radio" value="6" name="size">10x10<input type="radio" value="10" name="size">20x20<input type="radio" value="20" name="size"> </p></div>'),$(this.sel.find("input[type='submit']")).click(function(a){a.preventDefault()})}}function Grid(a,b,c,d,e){var f=this;this.form=$(e),this.players=[d,c],this.message=$(".message"),this.field=[],this.size=a,this.sel=$(".game"),this.buttons=[[],[]],this.cp=0,this.nextcp=1,this.bottomRow=new BottomRow(".bottom",this),this.isDone=[!1,!1],this.checkWin=function(){if(0===$("#"+this.cp).length){if(this.isDone[this.cp])return!0;console.log("no smoke")}return this.isDone[this.cp]&&console.log("reached end"),console.log("nither"),!1},this.init=function(a){this.bottomRow.init(),this.bottomRow.display();for(var b=0;b<this.size;b++)this.field.push(Array(this.size+2));this.displayInit();var c=new Pipes,d=c.startPipes(),e=this.size/2,g=e-3,h=e-2,i=e+2,j=e+1,k=this.size+1,l=c.makeSmoke(0),m=c.makeSmoke(0);l.isSmoke=!0,m.isSmoke=!0,l.cp=this.cp,m.cp=this.nextcp,f.field[g][1]=l,f.field[i][1]=m,this.buttons[this.nextcp].push([i,1]),this.buttons[this.cp].push([g,1]),d[1].isEnd=!0,this.addStart(g,k,d[2]),this.addStart(h,k,d[1]),this.addStart(g,0,d[0]),this.changeCP(),this.addStart(e,k,d[2]),this.addStart(j,k,d[1]),this.addStart(i,0,d[0]),this.changeTurn(),this.changeTurn(),this.message.html("<p>It is "+this.players[this.cp]+"'s turn!")},this.changeCP=function(){cp=this.cp,this.cp=this.nextcp,this.nextcp=cp,this.message.html("<p>It is "+this.players[this.cp]+"'s turn!")},this.addStart=function(a,b,c){var d=$($(this.sel.find(".row")[a]).find(".cell")[b]),e=c.display();d.html("<img src='"+e+"'>"),this.field[a][b]=c},this.addPipe=function(a,b){var c=$("input[name='pipe']:checked").val();if(c){var d=this.bottomRow.copyIt(c);if(!0===this.doesItConnect(d,a,b)){var d=this.bottomRow.popIt(c),e=$($(this.sel.find(".row")[a]).find(".cell")[b]),f=d.display();return e.html("<img src='"+f+"'>"),this.field[a][b]=d,this.makeSmoke(d,a,b),!0}return!1}return!1},this.makeSmoke=function(a,b,c){b=parseInt(b),c=parseInt(c);for(var d=a.getOpen(),e=[[b,c+1],[b+1,c],[b,c-1],[b-1,c]],f=0;f<d.length;f++){var g=e[d[f]];this.buttons[this.nextcp].push(g);var h=new Pipes,i=h.makeSmoke(d[f]);i.isSmoke=!0,i.cp=this.cp,this.field[g[0]][g[1]]=i}},this.isOutOfBounds=function(a){var b=a[0],c=a[1];return b<0||(b>=this.size||(c<0||c>=this.size+2))},this.doesItConnect=function(a,b,c){var d=this;b=parseInt(b),c=parseInt(c);for(var e=a.getConnect(),f=[[b,c+1],[b+1,c],[b,c-1],[b-1,c]],g=0;g<e.length;g++){var h=e[g],i=f[h],j=i[0],k=i[1];if(!0===this.isOutOfBounds(i))return console.log("Connection Goes Out Of Bounds"),!1;try{console.log(d.field[j][k])}catch(a){return!1}if(console.log(d.field[j][k]),d.field[j][k]){if(d.field[j][k].isSmoke&&d.field[j][k].cp!==this.cp)return console.log("Smoke Error"),console.log(d.field[j][k]),console.log(d.cp),!1;var l=d.field[j][k],m=l.getOpen(),n=[];if(m.forEach(function(a){n.push((a+2)%4)}),-1===n.indexOf(h))return console.log(m,h),console.log("Does not Connect"),console.log("Pipe it does not Connect to :",l),!1;if(!1===d.field[j][k].isSmoke){!0===l.isEnd&&(this.isDone[this.cp]=!0),a.removeOpen(h);var o=!0}}}for(var g=0;g<4;g++)if(-1==e.indexOf(g)){var p=f[g],q=p[0],r=p[1];try{console.log(d.field[q][r])}catch(a){continue}if(d.field[q][r]&&!1===d.field[q][r].isSmoke){var s=d.field[q][r].getOpen();if(-1!==s.indexOf((g+2)%4))return!1}}return!!o},this.changeTurn=function(){console.log("change turn"),f=this;var a=this.buttons[this.cp],b=this.buttons[this.nextcp];a.forEach(function(a){var b=a[0],c=a[1];if(!0===f.field[b][c].isSmoke){var d=f.field[b][c],e=d.display();$($(f.sel.find(".row")[b]).find(".cell")[c]).html('<img class="leak" id="'+f.nextcp+'" src="'+e+'" alt="smoke">')}}),b.forEach(function(a){var b=a[0],c=a[1];if(!0===f.field[b][c].isSmoke){var d=f.field[b][c],e=d.display();$($(f.sel.find(".row")[b]).find(".cell")[c]).html('<input type="submit" id="'+f.cp+'" class="leak" name="leak" value="'+b+","+c+'" style="background-image: url('+e+'">')}}),$(this.sel.find(".leak")).click(function(a){a.preventDefault();var b=$(this).val().split(","),c=b[0],d=b[1];!0===f.addPipe(c,d)&&(!0===f.checkWin()&&f.changePictures(),f.changeCP(),f.bottomRow.changeTurn(),f.changeTurn())})},this.changePictures=function(){var a=new Pipes,b=a.endPipes(),c=this.size/2,d=c-3,e=c-2,f=c+2,g=c+1,h=this.size+1;0===this.nextcp?(this.addStart(d,h,b[2]),this.addStart(e,h,b[1]),this.addStart(d,0,b[0])):(this.addStart(c,h,b[2]),this.addStart(g,h,b[1]),this.addStart(f,0,b[0]))},this.displayInit=function(){for(var a="",b=0;b<this.size;b++){a+='<div class="row">';for(var c=0;c<this.size+2;c++)a+='<div class="cell"></div>';a+="</div>"}this.sel.html(a)}}function BottomRow(a,b){this.grid=b,this.sel=$(a),this.sel.html("<div class='pipes'></div><div class='buttons'></div>"),this.pipes=$(this.sel.find(".pipes")),this.buttons=$(this.sel.find(".buttons")),this.currentPipes=[],this.nextPipes=[];var c=this;this.init=function(){for(var a=new Pipes,b=0;b<5;b++)this.currentPipes.push(a.returnRandom());for(var b=0;b<5;b++)this.nextPipes.push(a.returnRandom());this.buttons.html('<input type="submit" name="rotate" value="Rotate"><input type="submit" name="discard" value="Discard"><input type="submit" name="open_valve" value="Open Valve"><input type="submit" name="clear" value="Give Up">'),$(this.sel.find("input")).click(function(a){a.preventDefault(),c.handleButtonClick(this)})},this.popIt=function(a){var b=new Pipes,c=this.currentPipes[a];return this.currentPipes[a]=b.returnRandom(),c},this.copyIt=function(a){return this.currentPipes[a]},this.changeTurn=function(){cp=this.currentPipes,this.currentPipes=this.nextPipes,this.nextPipes=cp;for(var a=0;a<this.currentPipes.length;a++){var b=this.currentPipes[a].display();$(this.pipes.find("img")[a]).attr("src",b)}},this.handleButtonClick=function(a){var b=a.value;if("Rotate"===b){var c=$("input[name='pipe']:checked").val();if(c){this.currentPipes[c].rotate();var d=this.currentPipes[c].display();$(this.pipes.find("img")[c]).attr("src",d)}}else if("Discard"===b){var c=$("input[name='pipe']:checked").val();if(c){var e=new Pipes,f=e.returnRandom(),d=f.display();this.currentPipes[c]=f,$(this.pipes.find("img")[c]).attr("src",d),this.grid.changeCP(),this.changeTurn(),this.grid.changeTurn()}}else"Open Valve"===b?!0===this.grid.checkWin()&&this.grid.form.html("<div class='title'><h1>"+this.grid.players[this.grid.cp]+" Wins!</h1><input type='submit' value='New Game'></div>"):"Give Up"===b&&this.grid.form.html("<div class='title'><h1>"+this.grid.players[this.grid.nextcp]+" Wins!</h1><input type='submit' value='New Game'></div>")},this.display=function(){for(var a="",b=0;b<5;b++){var c=this.currentPipes[b].display();a+='<img src="'+c+'" alt="'+c+'"><input type="radio" value="'+b+'" name="pipe">'}this.pipes.html(a)}}function Pipes(){this.returnRandom=function(){var a=Math.floor(4*Math.random());return 0===a?this.make_cap():1===a?this.make_ninety():2===a?this.make_straight():this.make_tee()},this.startPipes=function(){return[new Pipe(["valve-closed.png"],[[0]],[[0]],0),new Pipe(["gauge-0.png"],[[2]],[[2]],0),new Pipe(["gauge-top-0.png"],[[-1]],[[-1]],0)]},this.endPipes=function(){return[new Pipe(["valve-open.png"],[[0]],[[0]],0),new Pipe(["gauge-190.png"],[[2]],[[2]],0),new Pipe(["gauge-top-190.png"],[[-1]],[[-1]],0)]},this.make_cap=function(){var a=["cap-e.png","cap-s.png","cap-w.png","cap-n.png"];return new Pipe(a,[[-1],[-1],[-1],[-1]],[[0],[1],[2],[3]],Math.floor(Math.random()*a.length))},this.make_ninety=function(){var a=["ninety-es.png","ninety-sw.png","ninety-wn.png","ninety-ne.png"];return new Pipe(a,[[0,1],[1,2],[2,3],[3,0]],[[0,1],[1,2],[2,3],[3,0]],Math.floor(Math.random()*a.length))},this.make_straight=function(){var a=["straight-h.png","straight-v.png"];return new Pipe(a,[[0,2],[1,3]],[[0,2],[1,3]],Math.floor(Math.random()*a.length))},this.make_tee=function(){var a=["tee-esw.png","tee-swn.png","tee-wne.png","tee-nes.png"];return new Pipe(a,[[0,1,2],[1,2,3],[2,3,0],[1,0,3]],[[0,1,2],[1,2,3],[2,3,0],[1,0,3]],Math.floor(Math.random()*a.length))},this.makeSmoke=function(a){return new Pipe(["leak-w.png","leak-n.png","leak-e.png","leak-s.png"],[[0,1,2,3],[0,1,2,3],[0,1,2,3],[0,1,2,3]],[[0],[1],[2],[3]],a)}}function Pipe(a,b,c,d){this.isSmoke=!1,this.filenames=a,this.open=b,this.connect=c,this.rotation=d,this.size=a.length,this.rotate=function(){this.rotation=(this.rotation+1)%this.size},this.display=function(){return"images/"+this.filenames[this.rotation]},this.getOpen=function(){return this.open[this.rotation]},this.getConnect=function(){return this.connect[this.rotation]},this.removeOpen=function(a){var b=this.open[this.rotation].indexOf(a);this.open[this.rotation].splice(b,1)}}